{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 48, "column": 0}, "map": {"version":3,"sources":["file:///G:/Himanshu/gaur/src/lib/prisma.ts"],"sourcesContent":["import { Pool } from 'pg'\r\nimport { PrismaPg } from '@prisma/adapter-pg'\r\nimport { PrismaClient } from '@prisma/client'\r\n\r\nconst globalForPrisma = global as unknown as { prisma: PrismaClient }\r\n\r\nconst connectionString = process.env.DATABASE_URL\r\n\r\nconst pool = new Pool({ connectionString })\r\nconst adapter = new PrismaPg(pool)\r\n\r\nexport const prisma = globalForPrisma.prisma || new PrismaClient({ adapter })\r\n\r\nif (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma\r\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;;;;;;AAEA,MAAM;AAEN,MAAM,mBAAmB,QAAQ,GAAG,CAAC,YAAY;AAEjD,MAAM,OAAO,IAAI,qJAAI,CAAC;IAAE;AAAiB;AACzC,MAAM,UAAU,IAAI,yKAAQ,CAAC;AAEtB,MAAM,SAAS,gBAAgB,MAAM,IAAI,IAAI,sMAAY,CAAC;IAAE;AAAQ;AAE3E,wCAA2C,gBAAgB,MAAM,GAAG"}},
    {"offset": {"line": 80, "column": 0}, "map": {"version":3,"sources":["file:///G:/Himanshu/gaur/src/app/api/funnel/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport { prisma } from '@/lib/prisma';\r\n\r\nexport const dynamic = 'force-dynamic';\r\n\r\n// Default funnel stages\r\nconst defaultStages = [\r\n    { name: 'NEW', order: 1, color: '#9CA3AF' },\r\n    { name: 'CONTACTED', order: 2, color: '#3B82F6' },\r\n    { name: 'QUALIFIED', order: 3, color: '#8B5CF6' },\r\n    { name: 'PROPOSAL', order: 4, color: '#F59E0B' },\r\n    { name: 'WON', order: 5, color: '#10B981' },\r\n    { name: 'LOST', order: 6, color: '#EF4444' },\r\n];\r\n\r\nasync function ensureStagesExist() {\r\n    // Get all existing stages\r\n    const existingStages = await prisma.funnelStage.findMany({\r\n        orderBy: { order: 'asc' },\r\n    });\r\n\r\n    // Check for and clean up duplicates (case-insensitive)\r\n    const stagesByName = new Map<string, typeof existingStages>();\r\n    for (const stage of existingStages) {\r\n        const normalizedName = stage.name.toUpperCase();\r\n        if (!stagesByName.has(normalizedName)) {\r\n            stagesByName.set(normalizedName, []);\r\n        }\r\n        stagesByName.get(normalizedName)!.push(stage);\r\n    }\r\n\r\n    // Remove duplicate stages (keep the one with lowest order, merge leads)\r\n    for (const [normalizedName, stages] of stagesByName.entries()) {\r\n        if (stages.length > 1) {\r\n            console.log(`Found ${stages.length} duplicate \"${normalizedName}\" stages (case-insensitive), cleaning up...`);\r\n            const [keep, ...remove] = stages.sort((a, b) => a.order - b.order);\r\n\r\n            for (const duplicate of remove) {\r\n                // Move leads to the primary stage\r\n                await prisma.lead.updateMany({\r\n                    where: { stageId: duplicate.id },\r\n                    data: { stageId: keep.id },\r\n                });\r\n                // Delete the duplicate\r\n                await prisma.funnelStage.delete({\r\n                    where: { id: duplicate.id },\r\n                });\r\n                console.log(`  Deleted duplicate stage \"${duplicate.name}\" (id: ${duplicate.id}), merged leads to \"${keep.name}\"`);\r\n            }\r\n        }\r\n    }\r\n\r\n    // Create any missing default stages\r\n    if (existingStages.length === 0) {\r\n        for (const stage of defaultStages) {\r\n            await prisma.funnelStage.create({\r\n                data: stage,\r\n            });\r\n        }\r\n    }\r\n}\r\n\r\nexport async function GET() {\r\n    try {\r\n        await ensureStagesExist();\r\n\r\n        const stages = await prisma.funnelStage.findMany({\r\n            orderBy: { order: 'asc' },\r\n            include: {\r\n                leads: {\r\n                    orderBy: { createdAt: 'desc' },\r\n                    take: 50,\r\n                    select: {\r\n                        id: true,\r\n                        name: true,\r\n                        email: true,\r\n                        company: true,\r\n                        source: true,\r\n                        value: true,\r\n                        stageId: true,\r\n                    },\r\n                },\r\n                _count: {\r\n                    select: { leads: true },\r\n                },\r\n            },\r\n        });\r\n\r\n        // Calculate stats\r\n        const totalLeads = await prisma.lead.count();\r\n        const convertedLeads = await prisma.lead.count({\r\n            where: { convertedAt: { not: null } },\r\n        });\r\n        const totalValue = await prisma.lead.aggregate({\r\n            _sum: { value: true },\r\n        });\r\n\r\n        // Find WON stage (case-insensitive) for accurate value calculation\r\n        const wonStage = await prisma.funnelStage.findFirst({\r\n            where: { name: { equals: 'WON', mode: 'insensitive' } },\r\n        });\r\n        const wonValue = await prisma.lead.aggregate({\r\n            where: wonStage ? { stageId: wonStage.id } : { stageId: 'never-match' },\r\n            _sum: { value: true },\r\n        });\r\n\r\n        const stats = {\r\n            totalLeads,\r\n            convertedLeads,\r\n            conversionRate: totalLeads > 0 ? ((convertedLeads / totalLeads) * 100).toFixed(1) : '0',\r\n            totalValue: totalValue._sum.value || 0,\r\n            wonValue: wonValue._sum.value || 0,\r\n        };\r\n\r\n        return NextResponse.json({ stages, stats });\r\n    } catch (error) {\r\n        console.error('Error fetching funnel data:', error);\r\n        return NextResponse.json(\r\n            { error: 'Failed to fetch funnel data', stages: [], stats: null },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}